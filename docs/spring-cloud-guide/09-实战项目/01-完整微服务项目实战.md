# 完整微服务项目实战

## 项目需求分析

我们将构建一个简单的电商系统，包含以下服务：

1. **用户服务（user-service）**：用户注册、登录、查询
2. **商品服务（product-service）**：商品查询、库存管理
3. **订单服务（order-service）**：订单创建、查询
4. **支付服务（payment-service）**：支付处理
5. **Eureka Server**：服务注册中心
6. **Config Server**：配置中心
7. **API Gateway**：API 网关

### 服务调用关系

```
用户 → API Gateway → 用户服务
用户 → API Gateway → 商品服务
用户 → API Gateway → 订单服务 → 商品服务
订单服务 → 支付服务
```

## 项目架构设计

### 技术栈

- **Spring Boot 3.2.0**
- **Spring Cloud 2025.0**
- **Eureka**：服务注册与发现
- **Spring Cloud Config**：配置中心
- **Spring Cloud Gateway**：API 网关
- **OpenFeign**：服务调用
- **Resilience4j**：熔断降级
- **Spring Cloud Sleuth**：分布式追踪
- **MySQL**：数据库
- **Redis**：缓存（可选）

### 项目结构

```
ecommerce-microservices/
├── pom.xml                          # 父项目
├── eureka-server/                   # 服务注册中心
├── config-server/                   # 配置中心
├── api-gateway/                     # API 网关
├── user-service/                    # 用户服务
├── product-service/                 # 商品服务
├── order-service/                   # 订单服务
└── payment-service/                 # 支付服务
```

## 创建所有服务模块

### 1. 父项目 pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.example</groupId>
    <artifactId>ecommerce-microservices</artifactId>
    <version>1.0.0</version>
    <packaging>pom</packaging>

    <name>Ecommerce Microservices</name>
    <description>Spring Cloud 2025.0 电商微服务项目</description>

    <properties>
        <java.version>17</java.version>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <spring-boot.version>3.2.0</spring-boot.version>
        <spring-cloud.version>2025.0.0</spring-cloud.version>
    </properties>

    <modules>
        <module>eureka-server</module>
        <module>config-server</module>
        <module>api-gateway</module>
        <module>user-service</module>
        <module>product-service</module>
        <module>order-service</module>
        <module>payment-service</module>
    </modules>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>${spring-boot.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.springframework.boot</groupId>
                    <artifactId>spring-boot-maven-plugin</artifactId>
                    <version>${spring-boot.version}</version>
                </plugin>
            </plugins>
        </pluginManagement>
    </build>
</project>
```

### 2. Eureka Server

**pom.xml**：
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

**application.yml**：
```yaml
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  instance:
    hostname: localhost
  client:
    register-with-eureka: false
    fetch-registry: false
```

### 3. Config Server

**pom.xml**：
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-config-server</artifactId>
    </dependency>
</dependencies>
```

**application.yml**：
```yaml
server:
  port: 8888

spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        native:
          search-locations: classpath:/config
  profiles:
    active: native
```

### 4. API Gateway

**pom.xml**：
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-gateway</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
</dependencies>
```

**application.yml**：
```yaml
server:
  port: 8080

spring:
  application:
    name: api-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - StripPrefix=2
        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          filters:
            - StripPrefix=2
        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - StripPrefix=2
```

### 5. User Service

**pom.xml**：
```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-config</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>
</dependencies>
```

**bootstrap.yml**：
```yaml
spring:
  application:
    name: user-service
  cloud:
    config:
      uri: http://localhost:8888
      profile: dev
```

**application.yml**：
```yaml
server:
  port: 8081

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/ecommerce?useSSL=false&serverTimezone=UTC
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```

**UserController.java**：
```java
package com.example.user.controller;

import com.example.user.entity.User;
import com.example.user.service.UserService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/users")
public class UserController {
    
    @Autowired
    private UserService userService;
    
    @GetMapping("/{id}")
    public User getUser(@PathVariable Long id) {
        return userService.getUser(id);
    }
    
    @PostMapping
    public User createUser(@RequestBody User user) {
        return userService.createUser(user);
    }
}
```

### 6. Product Service

类似 User Service，提供商品查询功能。

### 7. Order Service

**pom.xml**（额外添加 OpenFeign）：
```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

**OrderController.java**：
```java
package com.example.order.controller;

import com.example.order.entity.Order;
import com.example.order.service.OrderService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/orders")
public class OrderController {
    
    @Autowired
    private OrderService orderService;
    
    @PostMapping
    public Order createOrder(@RequestBody Order order) {
        return orderService.createOrder(order);
    }
    
    @GetMapping("/{id}")
    public Order getOrder(@PathVariable Long id) {
        return orderService.getOrder(id);
    }
}
```

**ProductClient.java**：
```java
package com.example.order.client;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;

@FeignClient(name = "product-service")
public interface ProductClient {
    
    @GetMapping("/products/{id}")
    Product getProduct(@PathVariable Long id);
}
```

### 8. Payment Service

类似其他服务，提供支付处理功能。

## 配置各组件

### 1. 服务注册

所有服务都需要注册到 Eureka Server，配置 `eureka.client.service-url.defaultZone`。

### 2. 配置中心

所有服务从 Config Server 获取配置，使用 `bootstrap.yml` 配置 Config Server 地址。

### 3. API 网关路由

在 Gateway 中配置所有服务的路由规则。

### 4. 服务调用

使用 OpenFeign 进行服务间调用，配置熔断降级。

## 服务间调用

### Order Service 调用 Product Service

```java
@Service
public class OrderService {
    
    @Autowired
    private ProductClient productClient;
    
    public Order createOrder(Order order) {
        // 调用商品服务获取商品信息
        Product product = productClient.getProduct(order.getProductId());
        
        // 创建订单
        order.setProductName(product.getName());
        order.setPrice(product.getPrice());
        
        return orderRepository.save(order);
    }
}
```

### 熔断降级配置

```yaml
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
    instances:
      productClient:
        baseConfig: default
```

```java
@FeignClient(
    name = "product-service",
    fallback = ProductClientFallback.class
)
public interface ProductClient {
    // ...
}
```

## 测试和部署

### 1. 启动顺序

1. Eureka Server
2. Config Server
3. 各个业务服务
4. API Gateway

### 2. 测试接口

```bash
# 创建用户
curl -X POST http://localhost:8080/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"张三","email":"zhangsan@example.com"}'

# 查询用户
curl http://localhost:8080/api/users/1

# 创建订单
curl -X POST http://localhost:8080/api/orders \
  -H "Content-Type: application/json" \
  -d '{"userId":1,"productId":1,"quantity":2}'
```

### 3. 查看服务注册

访问 http://localhost:8761 查看所有注册的服务。

### 4. 查看追踪数据

访问 http://localhost:9411 查看分布式追踪数据。

## 常见问题解决

### 1. 服务无法注册

**解决**：
- 检查 Eureka Server 是否启动
- 检查服务配置是否正确
- 检查网络是否连通

### 2. 配置无法获取

**解决**：
- 检查 Config Server 是否启动
- 检查 `bootstrap.yml` 配置是否正确
- 检查配置文件是否存在

### 3. 服务调用失败

**解决**：
- 检查服务是否已注册
- 检查 Feign 客户端配置是否正确
- 检查熔断器配置

### 4. 网关路由不生效

**解决**：
- 检查路由配置是否正确
- 检查服务是否已注册
- 检查断言条件是否匹配

## 项目优化建议

### 1. 性能优化

- 使用 Redis 缓存热点数据
- 使用数据库连接池
- 优化 SQL 查询

### 2. 安全优化

- 添加认证授权（Spring Security + OAuth2）
- 使用 HTTPS
- 添加请求限流

### 3. 监控优化

- 集成 Prometheus + Grafana
- 添加业务指标监控
- 设置告警规则

### 4. 部署优化

- 使用 Docker 容器化
- 使用 Kubernetes 编排
- 实现 CI/CD 自动化部署

## 总结

通过这个完整的实战项目，我们整合了 Spring Cloud 的核心组件：

- ✅ **服务注册与发现**：使用 Eureka 实现服务注册和发现
- ✅ **配置管理**：使用 Config Server 集中管理配置
- ✅ **API 网关**：使用 Gateway 实现统一入口
- ✅ **服务调用**：使用 OpenFeign 简化服务调用
- ✅ **熔断降级**：使用 Resilience4j 提高系统容错能力
- ✅ **分布式追踪**：使用 Sleuth + Zipkin 实现链路追踪

恭喜你完成了 Spring Cloud 2025.0 的学习！现在你已经具备了构建微服务系统的能力。继续深入学习，探索更多 Spring Cloud 的高级特性吧！

