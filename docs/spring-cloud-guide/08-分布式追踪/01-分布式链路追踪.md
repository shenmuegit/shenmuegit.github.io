# 分布式链路追踪

## 分布式追踪概念

在微服务架构中，一个请求可能经过多个服务，分布式链路追踪可以追踪请求在多个服务间的调用路径，帮助开发者：

- **问题定位**：快速定位问题发生的服务
- **性能分析**：分析每个服务的响应时间
- **依赖关系**：了解服务间的调用关系
- **调用链可视化**：可视化展示完整的调用链

### 核心概念

- **Trace（追踪）**：一次完整的请求链路
- **Span（跨度）**：Trace 中的一个操作单元
- **SpanId**：Span 的唯一标识
- **TraceId**：Trace 的唯一标识，贯穿整个调用链

## Spring Cloud Sleuth

Spring Cloud Sleuth 是 Spring Cloud 提供的分布式追踪解决方案，它可以自动为请求添加追踪信息。

### 主要功能

- 自动生成 TraceId 和 SpanId
- 集成日志框架，在日志中输出追踪信息
- 支持多种追踪系统（Zipkin、Jaeger 等）
- 支持异步调用追踪

## 添加依赖

在需要追踪的服务中添加依赖：

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-sleuth</artifactId>
    </dependency>
    <!-- Zipkin 集成（可选） -->
    <dependency>
        <groupId>io.zipkin.reporter2</groupId>
        <artifactId>zipkin-reporter-brave</artifactId>
    </dependency>
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
</dependencies>
```

**注意**：在 Spring Cloud 2025.0 中，Sleuth 已被 Micrometer Tracing 替代，但为了兼容性，仍可以使用 `spring-cloud-starter-sleuth`。

## 基础配置

### application.yml 配置

```yaml
spring:
  sleuth:
    # 采样率（0.0-1.0），1.0 表示 100% 采样
    sampler:
      probability: 1.0
    # Zipkin 配置
    zipkin:
      base-url: http://localhost:9411
      # 是否启用服务发现
      discovery-client-enabled: false
```

## 日志集成

Sleuth 会自动在日志中添加追踪信息：

```
[service-consumer,1234567890abcdef,1234567890abcdef,true]
```

格式说明：
- 第一个值：服务名
- 第二个值：TraceId
- 第三个值：SpanId
- 第四个值：是否导出到 Zipkin

### 日志配置

在 `logback-spring.xml` 中配置日志格式：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <springProperty scope="context" name="springAppName" source="spring.application.name"/>
    
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [${springAppName},%X{traceId},%X{spanId}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
</configuration>
```

## Zipkin 集成

Zipkin 是一个分布式追踪系统，可以收集、存储和展示追踪数据。

### 1. 启动 Zipkin

#### 方式一：使用 Docker

```bash
docker run -d -p 9411:9411 openzipkin/zipkin
```

#### 方式二：下载 JAR 包

```bash
curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar
```

#### 方式三：使用 Spring Boot

创建 `zipkin-server` 模块，添加依赖：

```xml
<dependencies>
    <dependency>
        <groupId>io.zipkin.java</groupId>
        <artifactId>zipkin-server</artifactId>
    </dependency>
    <dependency>
        <groupId>io.zipkin.java</groupId>
        <artifactId>zipkin-autoconfigure-ui</artifactId>
    </dependency>
</dependencies>
```

### 2. 配置服务发送数据到 Zipkin

在 `application.yml` 中配置：

```yaml
spring:
  sleuth:
    zipkin:
      base-url: http://localhost:9411
      # 是否启用服务发现
      discovery-client-enabled: false
```

### 3. 访问 Zipkin UI

启动 Zipkin 后，访问 http://localhost:9411 可以看到 Zipkin 的 Web 界面。

## 追踪配置

### 采样率配置

```yaml
spring:
  sleuth:
    sampler:
      # 采样率，1.0 表示 100% 采样
      probability: 1.0
```

### 自定义采样器

```java
package com.example.consumer.config;

import brave.sampler.Sampler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class TracingConfig {
    
    @Bean
    public Sampler defaultSampler() {
        // 总是采样
        return Sampler.create(1.0f);
    }
}
```

### 异步追踪

Sleuth 支持异步操作的追踪：

```java
package com.example.consumer.service;

import org.springframework.cloud.sleuth.annotation.NewSpan;
import org.springframework.cloud.sleuth.annotation.SpanTag;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.concurrent.CompletableFuture;

@Service
public class AsyncService {
    
    @Async
    @NewSpan("async-operation")
    public CompletableFuture<String> asyncOperation(@SpanTag("param") String param) {
        // 异步操作
        return CompletableFuture.completedFuture("Result: " + param);
    }
}
```

## 手动创建 Span

```java
package com.example.consumer.service;

import brave.Span;
import brave.Tracer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserService {
    
    @Autowired
    private Tracer tracer;
    
    public String getUser(String id) {
        Span span = tracer.nextSpan().name("getUser").start();
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            span.tag("user.id", id);
            // 业务逻辑
            return "User: " + id;
        } finally {
            span.end();
        }
    }
}
```

## 追踪数据存储

### 使用内存存储（默认）

Zipkin 默认使用内存存储，重启后数据会丢失。

### 使用 MySQL 存储

#### 1. 创建数据库

```sql
CREATE DATABASE zipkin;
```

#### 2. 执行初始化脚本

从 Zipkin 官网下载 SQL 脚本：https://github.com/openzipkin/zipkin/blob/master/zipkin-storage/zipkin-storage-mysql-v1/src/main/resources/mysql.sql

#### 3. 配置 Zipkin

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/zipkin
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### 使用 Elasticsearch 存储

#### 1. 启动 Elasticsearch

```bash
docker run -d -p 9200:9200 -p 9300:9300 elasticsearch:7.14.0
```

#### 2. 配置 Zipkin

```yaml
zipkin:
  storage:
    type: elasticsearch
    elasticsearch:
      hosts: http://localhost:9200
      index: zipkin
```

## 追踪最佳实践

### 1. 合理设置采样率

生产环境建议设置较低的采样率（如 0.1），避免影响性能。

### 2. 添加自定义标签

在关键操作处添加自定义标签，便于问题定位：

```java
span.tag("user.id", userId);
span.tag("order.id", orderId);
```

### 3. 异步操作追踪

对于异步操作，确保正确传递追踪上下文。

### 4. 数据库操作追踪

集成数据库追踪，了解数据库操作的性能：

```xml
<dependency>
    <groupId>io.zipkin.brave</groupId>
    <artifactId>brave-instrumentation-jdbc</artifactId>
</dependency>
```

## 查看追踪数据

### Zipkin UI

访问 http://localhost:9411，可以：

1. **搜索追踪**：根据服务名、时间范围等搜索
2. **查看调用链**：可视化展示完整的调用链
3. **分析性能**：查看每个 Span 的耗时
4. **依赖关系**：查看服务间的依赖关系

### 追踪数据格式

Zipkin 使用 JSON 格式存储追踪数据：

```json
{
  "traceId": "1234567890abcdef",
  "id": "1234567890abcdef",
  "name": "getUser",
  "timestamp": 1234567890000,
  "duration": 100,
  "localEndpoint": {
    "serviceName": "service-consumer"
  },
  "tags": {
    "user.id": "123"
  }
}
```

## 常见问题

### 1. 追踪信息不显示

**检查**：
- 是否添加了 Sleuth 依赖
- 采样率是否大于 0
- 日志配置是否正确

### 2. Zipkin 无法接收数据

**检查**：
- Zipkin 是否启动
- `base-url` 配置是否正确
- 网络是否连通

### 3. 异步操作追踪丢失

**解决**：使用 `@Async` 和 `@NewSpan` 注解，或手动传递追踪上下文。

## 下一步

分布式追踪帮助我们了解系统的运行情况。接下来我们将通过一个完整的实战项目，整合所有学到的知识。请继续学习下一章节：[完整微服务项目实战](../09-实战项目/01-完整微服务项目实战.md)。

