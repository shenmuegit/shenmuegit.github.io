---
layout: default
title: åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª
parent: åˆ†å¸ƒå¼è¿½è¸ª
grand_parent: Spring Cloud æ•™ç¨‹
nav_order: 1
---

# åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

> ğŸ“Š **éš¾åº¦**ï¼šğŸ”´ é«˜çº§ | â±ï¸ **é˜…è¯»æ—¶é—´**ï¼š35 åˆ†é’Ÿ
> 
> ğŸ“ **æœ¬ç« æ‘˜è¦**ï¼šå­¦ä¹ åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼Œé›†æˆ Sleuth å’Œ Zipkinï¼Œå®ç°è¯·æ±‚çš„å…¨é“¾è·¯ç›‘æ§ã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å­¦å®Œæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- ç†è§£åˆ†å¸ƒå¼è¿½è¸ªçš„æ¦‚å¿µ
- é…ç½® Spring Cloud Sleuth
- é›†æˆ Zipkin
- æŸ¥çœ‹å’Œåˆ†æè¿½è¸ªæ•°æ®
- æ’æŸ¥æ€§èƒ½é—®é¢˜

---

## åˆ†å¸ƒå¼è¿½è¸ªæ¦‚å¿µ

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½ç»è¿‡å¤šä¸ªæœåŠ¡ï¼Œåˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªå¯ä»¥è¿½è¸ªè¯·æ±‚åœ¨å¤šä¸ªæœåŠ¡é—´çš„è°ƒç”¨è·¯å¾„ï¼Œå¸®åŠ©å¼€å‘è€…ï¼š

- **é—®é¢˜å®šä½**ï¼šå¿«é€Ÿå®šä½é—®é¢˜å‘ç”Ÿçš„æœåŠ¡
- **æ€§èƒ½åˆ†æ**ï¼šåˆ†ææ¯ä¸ªæœåŠ¡çš„å“åº”æ—¶é—´
- **ä¾èµ–å…³ç³»**ï¼šäº†è§£æœåŠ¡é—´çš„è°ƒç”¨å…³ç³»
- **è°ƒç”¨é“¾å¯è§†åŒ–**ï¼šå¯è§†åŒ–å±•ç¤ºå®Œæ•´çš„è°ƒç”¨é“¾

### æ ¸å¿ƒæ¦‚å¿µ

- **Traceï¼ˆè¿½è¸ªï¼‰**ï¼šä¸€æ¬¡å®Œæ•´çš„è¯·æ±‚é“¾è·¯
- **Spanï¼ˆè·¨åº¦ï¼‰**ï¼šTrace ä¸­çš„ä¸€ä¸ªæ“ä½œå•å…ƒ
- **SpanId**ï¼šSpan çš„å”¯ä¸€æ ‡è¯†
- **TraceId**ï¼šTrace çš„å”¯ä¸€æ ‡è¯†ï¼Œè´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾

## Spring Cloud Sleuth

Spring Cloud Sleuth æ˜¯ Spring Cloud æä¾›çš„åˆ†å¸ƒå¼è¿½è¸ªè§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯ä»¥è‡ªåŠ¨ä¸ºè¯·æ±‚æ·»åŠ è¿½è¸ªä¿¡æ¯ã€‚

### ä¸»è¦åŠŸèƒ½

- è‡ªåŠ¨ç”Ÿæˆ TraceId å’Œ SpanId
- é›†æˆæ—¥å¿—æ¡†æ¶ï¼Œåœ¨æ—¥å¿—ä¸­è¾“å‡ºè¿½è¸ªä¿¡æ¯
- æ”¯æŒå¤šç§è¿½è¸ªç³»ç»Ÿï¼ˆZipkinã€Jaeger ç­‰ï¼‰
- æ”¯æŒå¼‚æ­¥è°ƒç”¨è¿½è¸ª

## æ·»åŠ ä¾èµ–

åœ¨éœ€è¦è¿½è¸ªçš„æœåŠ¡ä¸­æ·»åŠ ä¾èµ–ï¼š

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-sleuth</artifactId>
    </dependency>
    <!-- Zipkin é›†æˆï¼ˆå¯é€‰ï¼‰ -->
    <dependency>
        <groupId>io.zipkin.reporter2</groupId>
        <artifactId>zipkin-reporter-brave</artifactId>
    </dependency>
    <dependency>
        <groupId>io.micrometer</groupId>
        <artifactId>micrometer-tracing-bridge-brave</artifactId>
    </dependency>
</dependencies>
```

**æ³¨æ„**ï¼šåœ¨ Spring Cloud 2025.0 ä¸­ï¼ŒSleuth å·²è¢« Micrometer Tracing æ›¿ä»£ï¼Œä½†ä¸ºäº†å…¼å®¹æ€§ï¼Œä»å¯ä»¥ä½¿ç”¨ `spring-cloud-starter-sleuth`ã€‚

## åŸºç¡€é…ç½®

### application.yml é…ç½®

```yaml
spring:
  sleuth:
    # é‡‡æ ·ç‡ï¼ˆ0.0-1.0ï¼‰ï¼Œ1.0 è¡¨ç¤º 100% é‡‡æ ·
    sampler:
      probability: 1.0
    # Zipkin é…ç½®
    zipkin:
      base-url: http://localhost:9411
      # æ˜¯å¦å¯ç”¨æœåŠ¡å‘ç°
      discovery-client-enabled: false
```

## æ—¥å¿—é›†æˆ

Sleuth ä¼šè‡ªåŠ¨åœ¨æ—¥å¿—ä¸­æ·»åŠ è¿½è¸ªä¿¡æ¯ï¼š

```
[service-consumer,1234567890abcdef,1234567890abcdef,true]
```

æ ¼å¼è¯´æ˜ï¼š
- ç¬¬ä¸€ä¸ªå€¼ï¼šæœåŠ¡å
- ç¬¬äºŒä¸ªå€¼ï¼šTraceId
- ç¬¬ä¸‰ä¸ªå€¼ï¼šSpanId
- ç¬¬å››ä¸ªå€¼ï¼šæ˜¯å¦å¯¼å‡ºåˆ° Zipkin

### æ—¥å¿—é…ç½®

åœ¨ `logback-spring.xml` ä¸­é…ç½®æ—¥å¿—æ ¼å¼ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    
    <springProperty scope="context" name="springAppName" source="spring.application.name"/>
    
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [${springAppName},%X{traceId},%X{spanId}] %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>
</configuration>
```

## Zipkin é›†æˆ

Zipkin æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œå¯ä»¥æ”¶é›†ã€å­˜å‚¨å’Œå±•ç¤ºè¿½è¸ªæ•°æ®ã€‚

### 1. å¯åŠ¨ Zipkin

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Docker

```bash
docker run -d -p 9411:9411 openzipkin/zipkin
```

#### æ–¹å¼äºŒï¼šä¸‹è½½ JAR åŒ…

```bash
curl -sSL https://zipkin.io/quickstart.sh | bash -s
java -jar zipkin.jar
```

#### æ–¹å¼ä¸‰ï¼šä½¿ç”¨ Spring Boot

åˆ›å»º `zipkin-server` æ¨¡å—ï¼Œæ·»åŠ ä¾èµ–ï¼š

```xml
<dependencies>
    <dependency>
        <groupId>io.zipkin.java</groupId>
        <artifactId>zipkin-server</artifactId>
    </dependency>
    <dependency>
        <groupId>io.zipkin.java</groupId>
        <artifactId>zipkin-autoconfigure-ui</artifactId>
    </dependency>
</dependencies>
```

### 2. é…ç½®æœåŠ¡å‘é€æ•°æ®åˆ° Zipkin

åœ¨ `application.yml` ä¸­é…ç½®ï¼š

```yaml
spring:
  sleuth:
    zipkin:
      base-url: http://localhost:9411
      # æ˜¯å¦å¯ç”¨æœåŠ¡å‘ç°
      discovery-client-enabled: false
```

### 3. è®¿é—® Zipkin UI

å¯åŠ¨ Zipkin åï¼Œè®¿é—® http://localhost:9411 å¯ä»¥çœ‹åˆ° Zipkin çš„ Web ç•Œé¢ã€‚

## è¿½è¸ªé…ç½®

### é‡‡æ ·ç‡é…ç½®

```yaml
spring:
  sleuth:
    sampler:
      # é‡‡æ ·ç‡ï¼Œ1.0 è¡¨ç¤º 100% é‡‡æ ·
      probability: 1.0
```

### è‡ªå®šä¹‰é‡‡æ ·å™¨

```java
package com.example.consumer.config;

import brave.sampler.Sampler;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class TracingConfig {
    
    @Bean
    public Sampler defaultSampler() {
        // æ€»æ˜¯é‡‡æ ·
        return Sampler.create(1.0f);
    }
}
```

### å¼‚æ­¥è¿½è¸ª

Sleuth æ”¯æŒå¼‚æ­¥æ“ä½œçš„è¿½è¸ªï¼š

```java
package com.example.consumer.service;

import org.springframework.cloud.sleuth.annotation.NewSpan;
import org.springframework.cloud.sleuth.annotation.SpanTag;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Service;

import java.util.concurrent.CompletableFuture;

@Service
public class AsyncService {
    
    @Async
    @NewSpan("async-operation")
    public CompletableFuture<String> asyncOperation(@SpanTag("param") String param) {
        // å¼‚æ­¥æ“ä½œ
        return CompletableFuture.completedFuture("Result: " + param);
    }
}
```

## æ‰‹åŠ¨åˆ›å»º Span

```java
package com.example.consumer.service;

import brave.Span;
import brave.Tracer;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class UserService {
    
    @Autowired
    private Tracer tracer;
    
    public String getUser(String id) {
        Span span = tracer.nextSpan().name("getUser").start();
        try (Tracer.SpanInScope ws = tracer.withSpanInScope(span)) {
            span.tag("user.id", id);
            // ä¸šåŠ¡é€»è¾‘
            return "User: " + id;
        } finally {
            span.end();
        }
    }
}
```

## è¿½è¸ªæ•°æ®å­˜å‚¨

### ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼ˆé»˜è®¤ï¼‰

Zipkin é»˜è®¤ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œé‡å¯åæ•°æ®ä¼šä¸¢å¤±ã€‚

### ä½¿ç”¨ MySQL å­˜å‚¨

#### 1. åˆ›å»ºæ•°æ®åº“

```sql
CREATE DATABASE zipkin;
```

#### 2. æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬

ä» Zipkin å®˜ç½‘ä¸‹è½½ SQL è„šæœ¬ï¼šhttps://github.com/openzipkin/zipkin/blob/master/zipkin-storage/zipkin-storage-mysql-v1/src/main/resources/mysql.sql

#### 3. é…ç½® Zipkin

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/zipkin
    username: root
    password: password
    driver-class-name: com.mysql.cj.jdbc.Driver
```

### ä½¿ç”¨ Elasticsearch å­˜å‚¨

#### 1. å¯åŠ¨ Elasticsearch

```bash
docker run -d -p 9200:9200 -p 9300:9300 elasticsearch:7.14.0
```

#### 2. é…ç½® Zipkin

```yaml
zipkin:
  storage:
    type: elasticsearch
    elasticsearch:
      hosts: http://localhost:9200
      index: zipkin
```

## è¿½è¸ªæœ€ä½³å®è·µ

### 1. åˆç†è®¾ç½®é‡‡æ ·ç‡

ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®è¾ƒä½çš„é‡‡æ ·ç‡ï¼ˆå¦‚ 0.1ï¼‰ï¼Œé¿å…å½±å“æ€§èƒ½ã€‚

### 2. æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾

åœ¨å…³é”®æ“ä½œå¤„æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼Œä¾¿äºé—®é¢˜å®šä½ï¼š

```java
span.tag("user.id", userId);
span.tag("order.id", orderId);
```

### 3. å¼‚æ­¥æ“ä½œè¿½è¸ª

å¯¹äºå¼‚æ­¥æ“ä½œï¼Œç¡®ä¿æ­£ç¡®ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡ã€‚

### 4. æ•°æ®åº“æ“ä½œè¿½è¸ª

é›†æˆæ•°æ®åº“è¿½è¸ªï¼Œäº†è§£æ•°æ®åº“æ“ä½œçš„æ€§èƒ½ï¼š

```xml
<dependency>
    <groupId>io.zipkin.brave</groupId>
    <artifactId>brave-instrumentation-jdbc</artifactId>
</dependency>
```

## æŸ¥çœ‹è¿½è¸ªæ•°æ®

### Zipkin UI

è®¿é—® http://localhost:9411ï¼Œå¯ä»¥ï¼š

1. **æœç´¢è¿½è¸ª**ï¼šæ ¹æ®æœåŠ¡åã€æ—¶é—´èŒƒå›´ç­‰æœç´¢
2. **æŸ¥çœ‹è°ƒç”¨é“¾**ï¼šå¯è§†åŒ–å±•ç¤ºå®Œæ•´çš„è°ƒç”¨é“¾
3. **åˆ†ææ€§èƒ½**ï¼šæŸ¥çœ‹æ¯ä¸ª Span çš„è€—æ—¶
4. **ä¾èµ–å…³ç³»**ï¼šæŸ¥çœ‹æœåŠ¡é—´çš„ä¾èµ–å…³ç³»

### è¿½è¸ªæ•°æ®æ ¼å¼

Zipkin ä½¿ç”¨ JSON æ ¼å¼å­˜å‚¨è¿½è¸ªæ•°æ®ï¼š

```json
{
  "traceId": "1234567890abcdef",
  "id": "1234567890abcdef",
  "name": "getUser",
  "timestamp": 1234567890000,
  "duration": 100,
  "localEndpoint": {
    "serviceName": "service-consumer"
  },
  "tags": {
    "user.id": "123"
  }
}
```

## å¸¸è§é—®é¢˜

### 1. è¿½è¸ªä¿¡æ¯ä¸æ˜¾ç¤º

**æ£€æŸ¥**ï¼š
- æ˜¯å¦æ·»åŠ äº† Sleuth ä¾èµ–
- é‡‡æ ·ç‡æ˜¯å¦å¤§äº 0
- æ—¥å¿—é…ç½®æ˜¯å¦æ­£ç¡®

### 2. Zipkin æ— æ³•æ¥æ”¶æ•°æ®

**æ£€æŸ¥**ï¼š
- Zipkin æ˜¯å¦å¯åŠ¨
- `base-url` é…ç½®æ˜¯å¦æ­£ç¡®
- ç½‘ç»œæ˜¯å¦è¿é€š

### 3. å¼‚æ­¥æ“ä½œè¿½è¸ªä¸¢å¤±

**è§£å†³**ï¼šä½¿ç”¨ `@Async` å’Œ `@NewSpan` æ³¨è§£ï¼Œæˆ–æ‰‹åŠ¨ä¼ é€’è¿½è¸ªä¸Šä¸‹æ–‡ã€‚

## ä¸‹ä¸€æ­¥

åˆ†å¸ƒå¼è¿½è¸ªå¸®åŠ©æˆ‘ä»¬äº†è§£ç³»ç»Ÿçš„è¿è¡Œæƒ…å†µã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼Œæ•´åˆæ‰€æœ‰å­¦åˆ°çš„çŸ¥è¯†ã€‚

---

| â¬…ï¸ ä¸Šä¸€ç«  | ğŸ  ç›®å½• | ä¸‹ä¸€ç«  â¡ï¸ |
|:----------|:------:|----------:|
| [Resilience4j ç†”æ–­å™¨](../07-ç†”æ–­é™çº§/01-Resilience4j-ç†”æ–­å™¨.md) | [è¿”å›ç›®å½•](../../../) | [å®Œæ•´å¾®æœåŠ¡é¡¹ç›®å®æˆ˜](../09-å®æˆ˜é¡¹ç›®/01-å®Œæ•´å¾®æœåŠ¡é¡¹ç›®å®æˆ˜.md) |

