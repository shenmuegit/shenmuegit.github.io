---
layout: default
title: å¹¶å‘æ¨¡å‹æ¼”è¿›ä¸“é¢˜
parent: æ€»ç»“ä¸å±•æœ›
grand_parent: JavaæŠ€æœ¯ç”Ÿæ€æ¼”è¿›
nav_order: 1
---

# å¹¶å‘æ¨¡å‹æ¼”è¿›ä¸“é¢˜

<p align="center">
  <img src="https://img.shields.io/badge/éš¾åº¦-é«˜çº§-red" alt="éš¾åº¦">
  <img src="https://img.shields.io/badge/é˜…è¯»æ—¶é•¿-50åˆ†é’Ÿ-blue" alt="æ—¶é•¿">
  <img src="https://img.shields.io/badge/JDK-1.5~21-red" alt="JDK">
</p>

---

## ğŸ“ å®Œæ•´æ¼”è¿›æ—¶é—´çº¿

```mermaid
timeline
    title Java å¹¶å‘æ¨¡å‹ 20 å¹´æ¼”è¿›
    section åŸºç¡€é˜¶æ®µ
        JDK 1.0 (1996) : Thread + synchronized
        JDK 1.2 (1998) : ThreadLocal
    section æ¡†æ¶åŒ–é˜¶æ®µ
        JDK 1.5 (2004) : JUC åŒ…
                       : Executor æ¡†æ¶
                       : Lock æ¥å£
                       : å¹¶å‘é›†åˆ
    section åˆ†æ²»é˜¶æ®µ
        JDK 7 (2011) : Fork/Join æ¡†æ¶
    section å¼‚æ­¥é˜¶æ®µ
        JDK 8 (2014) : CompletableFuture
                     : parallel Stream
    section è½»é‡åŒ–é˜¶æ®µ
        JDK 21 (2023) : Virtual Threads
                      : Structured Concurrency
```

---

## ğŸ¯ äº†è§£ç›®æ ‡

- âœ… å…¨é¢å›é¡¾ Java å¹¶å‘æ¨¡å‹çš„æ¼”è¿›å†ç¨‹
- âœ… ç†è§£æ¯ä¸ªé˜¶æ®µçš„è®¾è®¡åŠ¨æœºä¸è§£å†³çš„é—®é¢˜
- âœ… æŒæ¡å„ç§å¹¶å‘æ¨¡å‹çš„é€‚ç”¨åœºæ™¯
- âœ… å»ºç«‹å®Œæ•´çš„å¹¶å‘ç¼–ç¨‹çŸ¥è¯†ä½“ç³»

---

## 1. åŸºç¡€é˜¶æ®µï¼šThread + synchronized

### 1.1 JDK 1.0 åŸå§‹æ¨¡å‹

```java
// æœ€åŸå§‹çš„å¹¶å‘æ–¹å¼
public class Counter {
    private int count = 0;
    
    public synchronized void increment() {
        count++;
    }
    
    public synchronized int getCount() {
        return count;
    }
}

// åˆ›å»ºçº¿ç¨‹
Thread thread = new Thread(() -> {
    counter.increment();
});
thread.start();
thread.join();  // ç­‰å¾…å®Œæˆ
```

### 1.2 å±€é™æ€§

| é—®é¢˜ | å½±å“ |
|------|------|
| æ¯ä¸ªä»»åŠ¡ä¸€ä¸ªçº¿ç¨‹ | èµ„æºæµªè´¹ |
| synchronized ç²’åº¦ç²— | å¹¶å‘åº¦ä½ |
| wait/notify æ˜“å‡ºé”™ | å®¹æ˜“æ­»é” |
| æ— æ³•è·å–è¿”å›å€¼ | Runnable æ— è¿”å›å€¼ |

---

## 2. æ¡†æ¶åŒ–é˜¶æ®µï¼šJUC åŒ…

### 2.1 Executor æ¡†æ¶

```java
// çº¿ç¨‹æ± ç®¡ç†
ExecutorService executor = Executors.newFixedThreadPool(10);

// æäº¤ä»»åŠ¡
Future<String> future = executor.submit(() -> {
    return fetchData();
});

// è·å–ç»“æœ
String result = future.get();

executor.shutdown();
```

### 2.2 Lock ä¸å¹¶å‘é›†åˆ

```java
// æ›´çµæ´»çš„é”
Lock lock = new ReentrantLock();
lock.tryLock(1, TimeUnit.SECONDS);

// çº¿ç¨‹å®‰å…¨é›†åˆ
ConcurrentHashMap<String, Integer> map = new ConcurrentHashMap<>();
BlockingQueue<Task> queue = new LinkedBlockingQueue<>();
```

### 2.3 è§£å†³çš„é—®é¢˜

| ç‰¹æ€§ | è§£å†³çš„é—®é¢˜ |
|------|-----------|
| çº¿ç¨‹æ±  | çº¿ç¨‹å¤ç”¨ï¼Œæ§åˆ¶æ•°é‡ |
| Callable/Future | è·å–å¼‚æ­¥ç»“æœ |
| Lock | å¯ä¸­æ–­ã€å¯è¶…æ—¶ã€å…¬å¹³é” |
| å¹¶å‘é›†åˆ | çº¿ç¨‹å®‰å…¨çš„é«˜æ•ˆé›†åˆ |

---

## 3. åˆ†æ²»é˜¶æ®µï¼šFork/Join

### 3.1 å·¥ä½œçªƒå–

```java
// Fork/Join åˆ†æ²»è®¡ç®—
public class SumTask extends RecursiveTask<Long> {
    private final long[] array;
    private final int start, end;
    
    @Override
    protected Long compute() {
        if (end - start <= THRESHOLD) {
            // ç›´æ¥è®¡ç®—
            return computeSequentially();
        }
        
        int mid = (start + end) / 2;
        SumTask left = new SumTask(array, start, mid);
        SumTask right = new SumTask(array, mid, end);
        
        left.fork();  // å¼‚æ­¥æ‰§è¡Œå·¦åŠéƒ¨åˆ†
        Long rightResult = right.compute();  // å½“å‰çº¿ç¨‹è®¡ç®—å³åŠéƒ¨åˆ†
        Long leftResult = left.join();  // ç­‰å¾…å·¦åŠéƒ¨åˆ†ç»“æœ
        
        return leftResult + rightResult;
    }
}

// ä½¿ç”¨
ForkJoinPool pool = ForkJoinPool.commonPool();
Long result = pool.invoke(new SumTask(array, 0, array.length));
```

### 3.2 é€‚ç”¨åœºæ™¯

- CPU å¯†é›†å‹è®¡ç®—
- å¯åˆ†è§£çš„å¤§ä»»åŠ¡
- é€’å½’é—®é¢˜

---

## 4. å¼‚æ­¥é˜¶æ®µï¼šCompletableFuture

### 4.1 å¼‚æ­¥ç¼–æ’

```java
// é“¾å¼å¼‚æ­¥æ“ä½œ
CompletableFuture<String> future = CompletableFuture
    .supplyAsync(() -> fetchUser(userId))
    .thenApply(user -> fetchOrders(user))
    .thenApply(orders -> formatResult(orders))
    .exceptionally(e -> "Error: " + e.getMessage());

// ç»„åˆå¤šä¸ªå¼‚æ­¥æ“ä½œ
CompletableFuture<Void> all = CompletableFuture.allOf(
    fetchUserAsync(1L),
    fetchUserAsync(2L),
    fetchUserAsync(3L)
);

// ä»»æ„ä¸€ä¸ªå®Œæˆ
CompletableFuture<Object> any = CompletableFuture.anyOf(
    fetchFromSource1(),
    fetchFromSource2()
);
```

### 4.2 parallel Stream

```java
// å¹¶è¡Œæµå¤„ç†
List<String> results = users.parallelStream()
    .filter(u -> u.getAge() > 18)
    .map(User::getName)
    .collect(Collectors.toList());
```

---

## 5. è½»é‡åŒ–é˜¶æ®µï¼šVirtual Threads

### 5.1 è™šæ‹Ÿçº¿ç¨‹

```java
// åˆ›å»ºç™¾ä¸‡çº§è™šæ‹Ÿçº¿ç¨‹
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 1_000_000).forEach(i -> {
        executor.submit(() -> {
            Thread.sleep(1000);  // æ¨¡æ‹Ÿ I/O
            return i;
        });
    });
}
```

### 5.2 ç»“æ„åŒ–å¹¶å‘ï¼ˆé¢„è§ˆï¼‰

```java
// JDK 21 ç»“æ„åŒ–å¹¶å‘
try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
    Future<User> user = scope.fork(() -> fetchUser(id));
    Future<Orders> orders = scope.fork(() -> fetchOrders(id));
    
    scope.join();           // ç­‰å¾…æ‰€æœ‰å­ä»»åŠ¡
    scope.throwIfFailed();  // ä¼ æ’­å¼‚å¸¸
    
    return new UserProfile(user.resultNow(), orders.resultNow());
}
```

---

## 6. ä»£ç æ¼”è¿›å¯¹æ¯”

```java
// ========== JDK 1.0: åŸå§‹ Thread ==========
List<Thread> threads = new ArrayList<>();
for (int i = 0; i < 10; i++) {
    Thread t = new Thread(new MyTask(i));
    threads.add(t);
    t.start();
}
for (Thread t : threads) {
    t.join();
}

// ========== JDK 1.5: Executor ==========
ExecutorService executor = Executors.newFixedThreadPool(10);
List<Future<Result>> futures = new ArrayList<>();
for (int i = 0; i < 10; i++) {
    futures.add(executor.submit(new MyCallable(i)));
}
for (Future<Result> f : futures) {
    Result r = f.get();
}
executor.shutdown();

// ========== JDK 8: CompletableFuture ==========
List<CompletableFuture<Result>> futures = IntStream.range(0, 10)
    .mapToObj(i -> CompletableFuture.supplyAsync(() -> process(i)))
    .toList();
    
CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
    .thenRun(() -> System.out.println("All done"));

// ========== JDK 21: Virtual Threads ==========
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    List<Future<Result>> futures = IntStream.range(0, 10)
        .mapToObj(i -> executor.submit(() -> process(i)))
        .toList();
    
    futures.forEach(f -> {
        try { f.get(); } catch (Exception e) { }
    });
}
```

---

## 7. æ¨¡å‹å¯¹æ¯”æ€»ç»“

| æ¨¡å‹ | é€‚ç”¨åœºæ™¯ | å¤æ‚åº¦ | æ€§èƒ½ç‰¹ç‚¹ |
|------|----------|:------:|----------|
| Thread + synchronized | ç®€å•åœºæ™¯ | ä½ | èµ„æºæ¶ˆè€—å¤§ |
| Executor + Future | é€šç”¨åœºæ™¯ | ä¸­ | çº¿ç¨‹æ± å¤ç”¨ |
| Fork/Join | CPU å¯†é›†å‹åˆ†æ²» | é«˜ | å·¥ä½œçªƒå– |
| CompletableFuture | å¼‚æ­¥ç¼–æ’ | é«˜ | éé˜»å¡ç»„åˆ |
| Virtual Thread | I/O å¯†é›†å‹é«˜å¹¶å‘ | ä½ | è½»é‡çº§çº¿ç¨‹ |

---

## 8. ä¸å…¶ä»–è¯­è¨€å¯¹æ¯”

| è¯­è¨€ | å¹¶å‘æ¨¡å‹ | ç‰¹ç‚¹ |
|------|----------|------|
| Java | Thread â†’ Virtual Thread | æ¼”è¿›æ¸è¿› |
| Go | Goroutine | åŸç”Ÿè½»é‡çº§ |
| Kotlin | Coroutine | åç¨‹ |
| Rust | async/await | é›¶æˆæœ¬æŠ½è±¡ |
| JavaScript | Event Loop + async | å•çº¿ç¨‹å¼‚æ­¥ |

---

## 9. é¢è¯•è€ƒç‚¹æ±‡æ€»

| è€ƒç‚¹ | å…³é”®çŸ¥è¯† |
|------|----------|
| synchronized vs Lock | Lock æ›´çµæ´»ï¼šå¯ä¸­æ–­ã€è¶…æ—¶ã€å…¬å¹³ |
| ConcurrentHashMap | JDK 7 åˆ†æ®µé”ï¼ŒJDK 8 CAS + synchronized |
| çº¿ç¨‹æ± å‚æ•° | æ ¸å¿ƒæ•°ã€æœ€å¤§æ•°ã€é˜Ÿåˆ—ã€æ‹’ç»ç­–ç•¥ |
| Fork/Join | å·¥ä½œçªƒå–ç®—æ³• |
| CompletableFuture | thenApply/thenCompose/thenCombine |
| Virtual Thread | è½½ä½“çº¿ç¨‹ã€Pinning |

---

## 10. æ¼”è¿›è§„å¾‹

### 10.1 ä»æ‰‹åŠ¨åˆ°æ¡†æ¶

```
æ‰‹åŠ¨ Thread â†’ Executor æ¡†æ¶ â†’ è™šæ‹Ÿçº¿ç¨‹

å°†çº¿ç¨‹ç®¡ç†äº¤ç»™æ¡†æ¶/è¿è¡Œæ—¶ï¼Œå¼€å‘è€…ä¸“æ³¨ä¸šåŠ¡ã€‚
```

### 10.2 ä»é‡é‡çº§åˆ°è½»é‡çº§

```
OS çº¿ç¨‹ï¼ˆMBï¼‰â†’ è™šæ‹Ÿçº¿ç¨‹ï¼ˆKBï¼‰

èµ„æºæ¶ˆè€—ä¸æ–­é™ä½ï¼Œå¹¶å‘èƒ½åŠ›ä¸æ–­æå‡ã€‚
```

### 10.3 ä»å¤æ‚åˆ°ç®€å•

```
å›è°ƒåœ°ç‹± â†’ CompletableFuture â†’ è™šæ‹Ÿçº¿ç¨‹åŒæ­¥ä»£ç 

æœ€ç»ˆå›å½’ç®€å•çš„åŒæ­¥ç¼–ç¨‹æ¨¡å‹ã€‚
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Java Concurrency in Practice](https://jcip.net/)
- [JEP 444: Virtual Threads](https://openjdk.org/jeps/444)
- [JEP 453: Structured Concurrency](https://openjdk.org/jeps/453)

---

<p align="center">
  â¬…ï¸ <a href="../06-JDK17-21æ—¶ä»£/03-GraalVMä¸Native.md">ä¸Šä¸€ç¯‡ï¼šGraalVMä¸Native</a> |
  ğŸ  <a href="../../README.md">è¿”å›ç›®å½•</a> |
  <a href="./02-æ¼”è¿›è§„å¾‹ä¸æœªæ¥å±•æœ›.md">ä¸‹ä¸€ç¯‡ï¼šæ¼”è¿›è§„å¾‹ä¸æœªæ¥å±•æœ›</a> â¡ï¸
</p>

