---
layout: default
title: å“åº”å¼ç¼–ç¨‹å´›èµ·
parent: JDK 9-11 æ—¶ä»£
grand_parent: JavaæŠ€æœ¯ç”Ÿæ€æ¼”è¿›
nav_order: 2
---

# å“åº”å¼ç¼–ç¨‹å´›èµ·

<p align="center">
  <img src="https://img.shields.io/badge/éš¾åº¦-é«˜çº§-red" alt="éš¾åº¦">
  <img src="https://img.shields.io/badge/é˜…è¯»æ—¶é•¿-50åˆ†é’Ÿ-blue" alt="æ—¶é•¿">
  <img src="https://img.shields.io/badge/JDK-1.8~11-red" alt="JDK">
</p>

---

## ğŸ“ æ—¶é—´çº¿å®šä½

```mermaid
timeline
    title å“åº”å¼ç¼–ç¨‹æ¼”è¿›
    section æ—©æœŸæ¢ç´¢
        2013 : RxJava 1.0
        2014 : Reactive Streams è§„èŒƒ
    section æˆç†Ÿå‘å±•
        2016 : RxJava 2.0
        2017 : ğŸ“ Project Reactor
             : Spring 5 WebFlux
    section æ ‡å‡†åŒ–
        2017 JDK 9 : Flow API
```

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£å“åº”å¼ç¼–ç¨‹çš„èƒŒæ™¯ä¸åŠ¨æœº
- âœ… æŒæ¡ Reactive Streams è§„èŒƒçš„æ ¸å¿ƒæ¦‚å¿µ
- âœ… äº†è§£ Project Reactor çš„åŸºæœ¬ä½¿ç”¨
- âœ… è®¤è¯† Spring WebFlux çš„æ¶æ„è®¾è®¡

---

## ğŸ“– ç« èŠ‚æ‘˜è¦

å“åº”å¼ç¼–ç¨‹æ˜¯åº”å¯¹é«˜å¹¶å‘åœºæ™¯çš„æ–°èŒƒå¼ã€‚é€šè¿‡éé˜»å¡ I/O å’ŒèƒŒå‹æœºåˆ¶ï¼Œå®ƒèƒ½ä»¥æ›´å°‘çš„çº¿ç¨‹å¤„ç†æ›´å¤šçš„å¹¶å‘è¯·æ±‚ã€‚

---

## 1. å†å²èƒŒæ™¯ä¸ç—›ç‚¹

### 1.1 ä¼ ç»Ÿé˜»å¡æ¨¡å‹çš„é—®é¢˜

```mermaid
graph TB
    subgraph ä¼ ç»Ÿ Servlet æ¨¡å‹
        A[è¯·æ±‚] --> B[çº¿ç¨‹1]
        C[è¯·æ±‚] --> D[çº¿ç¨‹2]
        E[è¯·æ±‚] --> F[çº¿ç¨‹3]
        
        B -->|é˜»å¡ç­‰å¾…| G[æ•°æ®åº“æŸ¥è¯¢]
        D -->|é˜»å¡ç­‰å¾…| H[HTTP è°ƒç”¨]
    end
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªè¯·æ±‚å ç”¨ä¸€ä¸ªçº¿ç¨‹
- I/O ç­‰å¾…æ—¶çº¿ç¨‹è¢«é˜»å¡
- é«˜å¹¶å‘éœ€è¦å¤§é‡çº¿ç¨‹
- çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§

### 1.2 C10K é—®é¢˜

```java
// ä¼ ç»Ÿæ¨¡å‹ï¼š10000 å¹¶å‘éœ€è¦ 10000 çº¿ç¨‹
// æ¯ä¸ªçº¿ç¨‹çº¦ 1MB æ ˆå†…å­˜ = 10GB å†…å­˜

// å“åº”å¼æ¨¡å‹ï¼šå°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¿æ¥
// äº‹ä»¶é©±åŠ¨ï¼Œéé˜»å¡ I/O
```

---

## 2. Reactive Streams è§„èŒƒ

### 2.1 æ ¸å¿ƒæ¥å£

```java
// Publisher: å‘å¸ƒè€…
public interface Publisher<T> {
    void subscribe(Subscriber<? super T> s);
}

// Subscriber: è®¢é˜…è€…
public interface Subscriber<T> {
    void onSubscribe(Subscription s);
    void onNext(T t);
    void onError(Throwable t);
    void onComplete();
}

// Subscription: è®¢é˜…å…³ç³»
public interface Subscription {
    void request(long n);  // èƒŒå‹ï¼šè¯·æ±‚ n ä¸ªå…ƒç´ 
    void cancel();
}

// Processor: å¤„ç†å™¨ï¼ˆæ—¢æ˜¯å‘å¸ƒè€…åˆæ˜¯è®¢é˜…è€…ï¼‰
public interface Processor<T, R> extends Subscriber<T>, Publisher<R> {
}
```

### 2.2 èƒŒå‹æœºåˆ¶

```mermaid
sequenceDiagram
    participant S as Subscriber
    participant P as Publisher
    
    S->>P: subscribe()
    P->>S: onSubscribe(subscription)
    S->>P: request(10)
    P->>S: onNext(item1)
    P->>S: onNext(item2)
    Note over P,S: ...å‘é€ 10 ä¸ªå…ƒç´ 
    S->>P: request(5)
    P->>S: onNext(item11)
    Note over P,S: è®¢é˜…è€…æ§åˆ¶æ¶ˆè´¹é€Ÿç‡
```

---

## 3. Project Reactor

### 3.1 æ ¸å¿ƒç±»å‹

```java
// Mono: 0 æˆ– 1 ä¸ªå…ƒç´ 
Mono<User> user = userRepository.findById(1L);

// Flux: 0 åˆ° N ä¸ªå…ƒç´ 
Flux<User> users = userRepository.findAll();
```

### 3.2 åˆ›å»ºæµ

```java
// ä»å€¼åˆ›å»º
Mono<String> mono = Mono.just("Hello");
Flux<String> flux = Flux.just("a", "b", "c");

// ä»é›†åˆåˆ›å»º
Flux<Integer> fromList = Flux.fromIterable(List.of(1, 2, 3));

// ä»èŒƒå›´åˆ›å»º
Flux<Integer> range = Flux.range(1, 10);

// åŠ¨æ€ç”Ÿæˆ
Flux<Long> interval = Flux.interval(Duration.ofSeconds(1));

// ç©ºæµå’Œé”™è¯¯
Mono<String> empty = Mono.empty();
Mono<String> error = Mono.error(new RuntimeException("Error"));
```

### 3.3 æ“ä½œç¬¦

```java
Flux<String> result = Flux.just("Alice", "Bob", "Charlie")
    // è½¬æ¢
    .map(String::toUpperCase)
    
    // è¿‡æ»¤
    .filter(name -> name.length() > 3)
    
    // æ‰å¹³åŒ–
    .flatMap(name -> getUserByName(name))
    
    // åˆå¹¶
    .mergeWith(Flux.just("David"))
    
    // é”™è¯¯å¤„ç†
    .onErrorResume(e -> Flux.just("Default"))
    
    // æ—¥å¿—
    .log()
    
    // è®¢é˜…æ‰§è¡Œ
    .subscribe(
        item -> System.out.println("Received: " + item),
        error -> System.err.println("Error: " + error),
        () -> System.out.println("Completed")
    );
```

### 3.4 è°ƒåº¦å™¨

```java
Flux.range(1, 10)
    .publishOn(Schedulers.parallel())    // ä¸‹æ¸¸åœ¨å¹¶è¡Œçº¿ç¨‹æ‰§è¡Œ
    .map(i -> processItem(i))
    .subscribeOn(Schedulers.boundedElastic())  // è®¢é˜…åœ¨å¼¹æ€§çº¿ç¨‹æ± 
    .subscribe();

// è°ƒåº¦å™¨ç±»å‹
Schedulers.immediate()       // å½“å‰çº¿ç¨‹
Schedulers.single()          // å•ä¸€å¤ç”¨çº¿ç¨‹
Schedulers.parallel()        // å¹¶è¡Œçº¿ç¨‹æ± ï¼ˆCPU æ ¸å¿ƒæ•°ï¼‰
Schedulers.boundedElastic()  // å¼¹æ€§çº¿ç¨‹æ± ï¼ˆI/O æ“ä½œï¼‰
```

---

## 4. Spring WebFlux

### 4.1 æ¶æ„å¯¹æ¯”

```mermaid
graph TB
    subgraph Spring MVC
        A1[Servlet å®¹å™¨] --> B1[DispatcherServlet]
        B1 --> C1[åŒæ­¥ Controller]
        C1 --> D1[é˜»å¡ I/O]
    end
    
    subgraph Spring WebFlux
        A2[Netty/Undertow] --> B2[DispatcherHandler]
        B2 --> C2[å¼‚æ­¥ Handler]
        C2 --> D2[éé˜»å¡ I/O]
    end
```

### 4.2 WebFlux Controller

```java
@RestController
@RequestMapping("/users")
public class UserController {
    
    @Autowired
    private UserRepository userRepository;
    
    // è¿”å› Mono
    @GetMapping("/{id}")
    public Mono<User> findById(@PathVariable Long id) {
        return userRepository.findById(id);
    }
    
    // è¿”å› Flux
    @GetMapping
    public Flux<User> findAll() {
        return userRepository.findAll();
    }
    
    // æ¥æ”¶ Mono
    @PostMapping
    public Mono<User> create(@RequestBody Mono<User> user) {
        return user.flatMap(userRepository::save);
    }
    
    // SSE æœåŠ¡ç«¯æ¨é€
    @GetMapping(value = "/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<User> streamUsers() {
        return userRepository.findAll()
            .delayElements(Duration.ofSeconds(1));
    }
}
```

### 4.3 å‡½æ•°å¼ç«¯ç‚¹

```java
@Configuration
public class RouterConfig {
    
    @Bean
    public RouterFunction<ServerResponse> routes(UserHandler handler) {
        return RouterFunctions.route()
            .GET("/users", handler::findAll)
            .GET("/users/{id}", handler::findById)
            .POST("/users", handler::create)
            .build();
    }
}

@Component
public class UserHandler {
    
    public Mono<ServerResponse> findAll(ServerRequest request) {
        return ServerResponse.ok()
            .body(userRepository.findAll(), User.class);
    }
    
    public Mono<ServerResponse> findById(ServerRequest request) {
        Long id = Long.valueOf(request.pathVariable("id"));
        return userRepository.findById(id)
            .flatMap(user -> ServerResponse.ok().bodyValue(user))
            .switchIfEmpty(ServerResponse.notFound().build());
    }
}
```

---

## 5. ä»£ç æ¼”è¿›ç¤ºä¾‹

```java
// ========== ä¼ ç»Ÿé˜»å¡æ–¹å¼ ==========
@GetMapping("/user/{id}/orders")
public List<Order> getUserOrders(@PathVariable Long id) {
    User user = userService.findById(id);          // é˜»å¡
    List<Order> orders = orderService.findByUserId(id);  // é˜»å¡
    return orders;
}

// ========== å“åº”å¼æ–¹å¼ ==========
@GetMapping("/user/{id}/orders")
public Flux<Order> getUserOrders(@PathVariable Long id) {
    return userService.findById(id)                // éé˜»å¡
        .flatMapMany(user -> orderService.findByUserId(id));  // éé˜»å¡
}

// ========== ç»„åˆå¤šä¸ªå¼‚æ­¥æ“ä½œ ==========
@GetMapping("/dashboard/{userId}")
public Mono<Dashboard> getDashboard(@PathVariable Long userId) {
    Mono<User> user = userService.findById(userId);
    Mono<List<Order>> orders = orderService.findByUserId(userId).collectList();
    Mono<Account> account = accountService.findByUserId(userId);
    
    return Mono.zip(user, orders, account)
        .map(tuple -> new Dashboard(tuple.getT1(), tuple.getT2(), tuple.getT3()));
}
```

---

## 6. æŠ€æœ¯å…³è”åˆ†æ

### 6.1 å“åº”å¼ä¸ JDK ç‰¹æ€§

```mermaid
graph TB
    subgraph JDK ç‰¹æ€§
        A[JDK 8 Lambda] --> B[æµç•…çš„æ“ä½œç¬¦ API]
        C[JDK 8 CompletableFuture] --> D[å¼‚æ­¥ç¼–ç¨‹åŸºç¡€]
        E[JDK 9 Flow API] --> F[æ ‡å‡†åŒ–æ¥å£]
    end
    
    subgraph å“åº”å¼æ¡†æ¶
        B --> G[Reactor æ“ä½œç¬¦]
        D --> H[å¼‚æ­¥ç»„åˆ]
        F --> I[äº’æ“ä½œæ€§]
    end
```

### 6.2 ä½•æ—¶ä½¿ç”¨å“åº”å¼

| åœºæ™¯ | æ¨è |
|------|------|
| ä¼ ç»Ÿ CRUD | Spring MVC |
| é«˜å¹¶å‘ API | WebFlux |
| å®æ—¶æ¨é€ | WebFlux + SSE/WebSocket |
| å¾®æœåŠ¡ç½‘å…³ | WebFlux |
| CPU å¯†é›†å‹ | Spring MVC |

---

## 7. æ¼”è¿›è§„å¾‹æ€»ç»“

### 7.1 ä»åŒæ­¥åˆ°å¼‚æ­¥

```
åŒæ­¥é˜»å¡ â†’ å¼‚æ­¥å›è°ƒ â†’ å“åº”å¼æµ

ç¼–ç¨‹æ¨¡å‹ä¸æ–­æ¼”è¿›ä»¥åº”å¯¹å¹¶å‘æŒ‘æˆ˜ã€‚
```

### 7.2 æ ‡å‡†åŒ–è¶‹åŠ¿

```
RxJava ç§æœ‰ API â†’ Reactive Streams è§„èŒƒ â†’ JDK Flow API

è¡Œä¸šæ ‡å‡†åŒ–ï¼Œæ¡†æ¶å¯äº’æ“ä½œã€‚
```

---

## 8. ç‰¹æ®Šå…ƒç´ 

### ğŸ’¼ é¢è¯•è€ƒç‚¹

**Q1: å“åº”å¼ç¼–ç¨‹å’Œä¼ ç»Ÿç¼–ç¨‹çš„åŒºåˆ«ï¼Ÿ**

ç­”ï¼š
- ä¼ ç»Ÿï¼šåŒæ­¥é˜»å¡ï¼Œä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹
- å“åº”å¼ï¼šå¼‚æ­¥éé˜»å¡ï¼Œäº‹ä»¶é©±åŠ¨ï¼Œå°‘é‡çº¿ç¨‹å¤„ç†å¤§é‡è¯·æ±‚

**Q2: ä»€ä¹ˆæ˜¯èƒŒå‹ï¼Ÿ**

ç­”ï¼šèƒŒå‹ï¼ˆBackpressureï¼‰æ˜¯è®¢é˜…è€…æ§åˆ¶å‘å¸ƒè€…å‘é€é€Ÿç‡çš„æœºåˆ¶ã€‚å½“æ¶ˆè´¹è€…å¤„ç†ä¸è¿‡æ¥æ—¶ï¼Œå¯ä»¥å‘Šè¯‰ç”Ÿäº§è€…æ…¢ä¸€ç‚¹ï¼Œé˜²æ­¢å†…å­˜æº¢å‡ºã€‚

**Q3: Mono å’Œ Flux çš„åŒºåˆ«ï¼Ÿ**

ç­”ï¼š
- Monoï¼š0 æˆ– 1 ä¸ªå…ƒç´ ï¼Œç±»ä¼¼ Optional
- Fluxï¼š0 åˆ° N ä¸ªå…ƒç´ ï¼Œç±»ä¼¼ Stream

### ğŸ¤” äº‰è®®ä¸åæ€

å“åº”å¼ç¼–ç¨‹çš„å¤æ‚æ€§ï¼š
- è°ƒè¯•å›°éš¾ï¼ˆå¼‚æ­¥å †æ ˆï¼‰
- å­¦ä¹ æ›²çº¿é™¡å³­
- ä¸æ˜¯æ‰€æœ‰åœºæ™¯éƒ½éœ€è¦

> ğŸ’¡ **å»ºè®®**ï¼šåªåœ¨çœŸæ­£éœ€è¦é«˜å¹¶å‘ã€ä½å»¶è¿Ÿçš„åœºæ™¯ä½¿ç”¨å“åº”å¼ï¼Œä¼ ç»Ÿåœºæ™¯ç”¨ Spring MVC æ›´ç®€å•ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Reactive Streams Specification](https://www.reactive-streams.org/)
- [Project Reactor Documentation](https://projectreactor.io/docs)
- [Spring WebFlux Documentation](https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html)

---

<p align="center">
  â¬…ï¸ <a href="./01-æ¨¡å—åŒ–ä¸æ–°API.md">ä¸Šä¸€ç¯‡ï¼šæ¨¡å—åŒ–ä¸æ–°API</a> |
  ğŸ  <a href="../../README.md">è¿”å›ç›®å½•</a> |
  <a href="./03-äº‘åŸç”ŸåŸºç¡€è®¾æ–½.md">ä¸‹ä¸€ç¯‡ï¼šäº‘åŸç”ŸåŸºç¡€è®¾æ–½</a> â¡ï¸
</p>

