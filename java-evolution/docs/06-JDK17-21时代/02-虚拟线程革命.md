---
layout: default
title: è™šæ‹Ÿçº¿ç¨‹é©å‘½
parent: JDK 17-21 æ—¶ä»£
grand_parent: JavaæŠ€æœ¯ç”Ÿæ€æ¼”è¿›
nav_order: 2
---

# è™šæ‹Ÿçº¿ç¨‹é©å‘½

<p align="center">
  <img src="https://img.shields.io/badge/éš¾åº¦-é«˜çº§-red" alt="éš¾åº¦">
  <img src="https://img.shields.io/badge/é˜…è¯»æ—¶é•¿-55åˆ†é’Ÿ-blue" alt="æ—¶é•¿">
  <img src="https://img.shields.io/badge/JDK-19~21-red" alt="JDK">
</p>

---

## ğŸ“ æ—¶é—´çº¿å®šä½

```mermaid
timeline
    title Java å¹¶å‘æ¨¡å‹æ¼”è¿›
    section ä¼ ç»Ÿçº¿ç¨‹
        JDK 1.0 : Thread
        JDK 1.5 : Executor
        JDK 7 : Fork/Join
        JDK 8 : CompletableFuture
    section è™šæ‹Ÿçº¿ç¨‹
        2017 : Project Loom å¯åŠ¨
        JDK 19 : ğŸ“ Virtual Thread Preview
        JDK 21 : Virtual Thread æ­£å¼ç‰ˆ
```

---

## ğŸ¯ å­¦ä¹ ç›®æ ‡

- âœ… ç†è§£ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹çš„ç“¶é¢ˆ
- âœ… æŒæ¡è™šæ‹Ÿçº¿ç¨‹çš„æ ¸å¿ƒåŸç†
- âœ… äº†è§£è™šæ‹Ÿçº¿ç¨‹ä¸å“åº”å¼ç¼–ç¨‹çš„å¯¹æ¯”
- âœ… è®¤è¯†è™šæ‹Ÿçº¿ç¨‹å¯¹æ¡†æ¶çš„å½±å“

---

## ğŸ“– ç« èŠ‚æ‘˜è¦

è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadsï¼‰æ˜¯ Java å¹¶å‘ç¼–ç¨‹çš„é‡å¤§é©æ–°ã€‚å®ƒè®©å¼€å‘è€…å¯ä»¥ç”¨ç®€å•çš„åŒæ­¥ä»£ç å®ç°é«˜å¹¶å‘ï¼Œæ— éœ€å“åº”å¼ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚

---

## 1. ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹çš„é—®é¢˜

### 1.1 å¹³å°çº¿ç¨‹çš„æˆæœ¬

```mermaid
graph TB
    subgraph å¹³å°çº¿ç¨‹
        A[Java Thread] --> B[OS Thread]
        B --> C[å†…æ ¸è°ƒåº¦]
        
        D[1 Thread â‰ˆ 1MB æ ˆ]
        E[ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€]
    end
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªçº¿ç¨‹çº¦ 1MB æ ˆå†…å­˜
- æ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°é‡æœ‰é™ï¼ˆé€šå¸¸å‡ åƒï¼‰
- ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§

### 1.2 é«˜å¹¶å‘çš„å›°å¢ƒ

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ªçº¿ç¨‹
// 10000 å¹¶å‘ = 10000 çº¿ç¨‹ â‰ˆ 10GB å†…å­˜

public void handleRequest(Request request) {
    User user = userService.findById(request.getUserId());  // I/O é˜»å¡
    Order order = orderService.create(user, request);       // I/O é˜»å¡
    emailService.sendConfirmation(order);                   // I/O é˜»å¡
}

// çº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´åœ¨ç­‰å¾… I/Oï¼Œæµªè´¹èµ„æº
```

### 1.3 ä¹‹å‰çš„è§£å†³æ–¹æ¡ˆ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| çº¿ç¨‹æ±  | æ§åˆ¶çº¿ç¨‹æ•°é‡ | ä¸èƒ½çªç ´çº¿ç¨‹ä¸Šé™ |
| å¼‚æ­¥å›è°ƒ | éé˜»å¡ | å›è°ƒåœ°ç‹± |
| CompletableFuture | é“¾å¼è°ƒç”¨ | ä»£ç å¤æ‚ |
| å“åº”å¼ï¼ˆWebFluxï¼‰ | é«˜å¹¶å‘ | å­¦ä¹ æˆæœ¬é«˜ã€è°ƒè¯•éš¾ |

---

## 2. è™šæ‹Ÿçº¿ç¨‹åŸç†

### 2.1 åŸºæœ¬æ¦‚å¿µ

```mermaid
graph TB
    subgraph è™šæ‹Ÿçº¿ç¨‹æ¨¡å‹
        VT1[Virtual Thread 1] --> CT1[Carrier Thread 1]
        VT2[Virtual Thread 2] --> CT1
        VT3[Virtual Thread 3] --> CT2[Carrier Thread 2]
        VT4[Virtual Thread 4] --> CT2
        
        CT1 --> OS1[OS Thread]
        CT2 --> OS2[OS Thread]
    end
    
    N1[æ•°ç™¾ä¸‡è™šæ‹Ÿçº¿ç¨‹]
    N2[å°‘é‡è½½ä½“çº¿ç¨‹]
```

- **è™šæ‹Ÿçº¿ç¨‹**ï¼šè½»é‡çº§çº¿ç¨‹ï¼Œç”± JVM è°ƒåº¦
- **è½½ä½“çº¿ç¨‹**ï¼šå®é™…çš„å¹³å°çº¿ç¨‹ï¼Œæ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹çš„ä»£ç 
- **æŒ‚è½½/å¸è½½**ï¼šè™šæ‹Ÿçº¿ç¨‹é˜»å¡æ—¶ä»è½½ä½“çº¿ç¨‹å¸è½½ï¼Œæ¢å¤æ—¶é‡æ–°æŒ‚è½½

### 2.2 å·¥ä½œåŸç†

```java
// è™šæ‹Ÿçº¿ç¨‹é‡åˆ°é˜»å¡ I/O æ—¶
// 1. ä¿å­˜æ ˆåˆ°å †å†…å­˜
// 2. ä»è½½ä½“çº¿ç¨‹å¸è½½
// 3. è½½ä½“çº¿ç¨‹æ‰§è¡Œå…¶ä»–è™šæ‹Ÿçº¿ç¨‹
// 4. I/O å®Œæˆåï¼Œè™šæ‹Ÿçº¿ç¨‹é‡æ–°æŒ‚è½½

// è¿™ä¸€åˆ‡å¯¹å¼€å‘è€…é€æ˜ï¼
```

---

## 3. è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨

### 3.1 åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹

```java
// æ–¹å¼ 1: Thread.ofVirtual()
Thread vThread = Thread.ofVirtual().start(() -> {
    System.out.println("Running in virtual thread");
});

// æ–¹å¼ 2: Thread.startVirtualThread()
Thread vThread = Thread.startVirtualThread(() -> {
    System.out.println("Running in virtual thread");
});

// æ–¹å¼ 3: è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œå™¨
ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
executor.submit(() -> {
    System.out.println("Running in virtual thread");
});
```

### 3.2 å®é™…åº”ç”¨ç¤ºä¾‹

```java
// ä¼ ç»Ÿæ–¹å¼ï¼šçº¿ç¨‹æ± é™åˆ¶å¹¶å‘æ•°
ExecutorService executor = Executors.newFixedThreadPool(200);

// è™šæ‹Ÿçº¿ç¨‹ï¼šæ¯ä¸ªè¯·æ±‚ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œæ— éœ€æ‹…å¿ƒæ•°é‡
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 10_000).forEach(i -> {
        executor.submit(() -> {
            // æ¯ä¸ªä»»åŠ¡ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹
            User user = userService.findById(i);    // é˜»å¡æ—¶è‡ªåŠ¨è®©å‡º
            Order order = orderService.create(user); // é˜»å¡æ—¶è‡ªåŠ¨è®©å‡º
            return order;
        });
    });
}
```

### 3.3 Spring Boot é›†æˆ

```yaml
# Spring Boot 3.2+
spring:
  threads:
    virtual:
      enabled: true  # å¼€å¯è™šæ‹Ÿçº¿ç¨‹
```

```java
// Tomcat è‡ªåŠ¨ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¤„ç†è¯·æ±‚
@RestController
public class UserController {
    
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable Long id) {
        // å¯ä»¥æ”¾å¿ƒä½¿ç”¨é˜»å¡ä»£ç 
        return userService.findById(id);
    }
}
```

---

## 4. ä»£ç æ¼”è¿›ç¤ºä¾‹

```java
// ========== ä¼ ç»ŸåŒæ­¥ï¼ˆç®€å•ä½†ä¸æ”¯æŒé«˜å¹¶å‘ï¼‰==========
public List<User> getUsers(List<Long> ids) {
    List<User> users = new ArrayList<>();
    for (Long id : ids) {
        users.add(userService.findById(id));  // ä¸²è¡Œé˜»å¡
    }
    return users;
}

// ========== CompletableFutureï¼ˆå¤æ‚ï¼‰==========
public CompletableFuture<List<User>> getUsers(List<Long> ids) {
    List<CompletableFuture<User>> futures = ids.stream()
        .map(id -> CompletableFuture.supplyAsync(
            () -> userService.findById(id), executor))
        .toList();
    
    return CompletableFuture.allOf(futures.toArray(new CompletableFuture[0]))
        .thenApply(v -> futures.stream()
            .map(CompletableFuture::join)
            .toList());
}

// ========== å“åº”å¼ï¼ˆæ›´å¤æ‚ï¼‰==========
public Flux<User> getUsers(List<Long> ids) {
    return Flux.fromIterable(ids)
        .flatMap(id -> userService.findById(id))
        .collectList();
}

// ========== è™šæ‹Ÿçº¿ç¨‹ï¼ˆç®€å•ä¸”é«˜å¹¶å‘ï¼‰==========
public List<User> getUsers(List<Long> ids) throws Exception {
    try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
        List<Future<User>> futures = ids.stream()
            .map(id -> executor.submit(() -> userService.findById(id)))
            .toList();
        
        return futures.stream()
            .map(f -> f.get())  // ç®€å•çš„é˜»å¡ç­‰å¾…
            .toList();
    }
}
```

---

## 5. è™šæ‹Ÿçº¿ç¨‹ vs å“åº”å¼

### 5.1 å¯¹æ¯”åˆ†æ

| ç»´åº¦ | è™šæ‹Ÿçº¿ç¨‹ | å“åº”å¼ï¼ˆWebFluxï¼‰ |
|------|----------|-------------------|
| ç¼–ç¨‹æ¨¡å‹ | åŒæ­¥é˜»å¡ | å¼‚æ­¥éé˜»å¡ |
| ä»£ç å¤æ‚åº¦ | ä½ | é«˜ |
| è°ƒè¯•éš¾åº¦ | æ­£å¸¸å †æ ˆ | å¼‚æ­¥å †æ ˆéš¾è¿½è¸ª |
| å­¦ä¹ æ›²çº¿ | ä½ | é«˜ |
| ç”Ÿæ€æˆç†Ÿåº¦ | æ–°å…´ | æˆç†Ÿ |
| CPU å¯†é›†å‹ | ä¸é€‚åˆ | ä¸é€‚åˆ |
| I/O å¯†é›†å‹ | é€‚åˆ | é€‚åˆ |

### 5.2 é€‰æ‹©å»ºè®®

```mermaid
flowchart TD
    A[é€‰æ‹©å¹¶å‘æ¨¡å‹] --> B{ç°æœ‰ä»£ç åŸºç¡€?}
    B -->|æ–°é¡¹ç›®| C{å›¢é˜Ÿç†Ÿæ‚‰å“åº”å¼?}
    B -->|å·²æœ‰åŒæ­¥ä»£ç | D[è™šæ‹Ÿçº¿ç¨‹]
    C -->|æ˜¯| E[WebFlux]
    C -->|å¦| D
    
    F{æ˜¯å¦éœ€è¦èƒŒå‹?}
    F -->|æ˜¯| E
    F -->|å¦| D
```

---

## 6. æŠ€æœ¯å…³è”åˆ†æ

### 6.1 æ¡†æ¶æ”¯æŒ

| æ¡†æ¶ | æ”¯æŒç‰ˆæœ¬ | è¯´æ˜ |
|------|----------|------|
| Spring Boot | 3.2+ | é…ç½®å¼€å¯å³å¯ |
| Tomcat | 10.1+ | è‡ªåŠ¨é€‚é… |
| JDBC | - | éœ€è¦æ”¯æŒè™šæ‹Ÿçº¿ç¨‹çš„é©±åŠ¨ |
| Hibernate | 6.2+ | æ”¯æŒ |

### 6.2 æ³¨æ„äº‹é¡¹

```java
// âš ï¸ è™šæ‹Ÿçº¿ç¨‹çš„é™åˆ¶

// 1. synchronized ä¼šé˜»å¡è½½ä½“çº¿ç¨‹ï¼ˆPinningï¼‰
synchronized (lock) {
    // æ­¤æ—¶è™šæ‹Ÿçº¿ç¨‹æ— æ³•ä»è½½ä½“çº¿ç¨‹å¸è½½
    blockingOperation();  // ä¸æ¨è
}

// æ¨èä½¿ç”¨ ReentrantLock
lock.lock();
try {
    blockingOperation();  // å¯ä»¥æ­£å¸¸å¸è½½
} finally {
    lock.unlock();
}

// 2. ThreadLocal å¯èƒ½æ¶ˆè€—å¤§é‡å†…å­˜
// æ¯ä¸ªè™šæ‹Ÿçº¿ç¨‹éƒ½æœ‰ç‹¬ç«‹çš„ ThreadLocal å‰¯æœ¬
```

---

## 7. æ¼”è¿›è§„å¾‹æ€»ç»“

### 7.1 ç®€åŒ–é«˜å¹¶å‘

```
çº¿ç¨‹æ± ï¼ˆå¤æ‚ï¼‰â†’ å“åº”å¼ï¼ˆæ›´å¤æ‚ï¼‰â†’ è™šæ‹Ÿçº¿ç¨‹ï¼ˆç®€å•ï¼‰

æœ€ç»ˆå›å½’ç®€å•çš„åŒæ­¥ç¼–ç¨‹æ¨¡å‹ã€‚
```

### 7.2 é€æ˜ä¼˜åŒ–

```
æ˜¾å¼å¼‚æ­¥ â†’ éšå¼å¼‚æ­¥

å¼€å‘è€…å†™åŒæ­¥ä»£ç ï¼ŒJVM è‡ªåŠ¨ä¼˜åŒ–å¹¶å‘ã€‚
```

---

## 8. ç‰¹æ®Šå…ƒç´ 

### ğŸ‘¤ å…³é”®äººç‰©ï¼šRon Pressler

Ron Pressler æ˜¯ Project Loom çš„æŠ€æœ¯è´Ÿè´£äººï¼Œæ¨åŠ¨äº†è™šæ‹Ÿçº¿ç¨‹ä»æ¦‚å¿µåˆ°å®ç°ã€‚

### ğŸ’¼ é¢è¯•è€ƒç‚¹

**Q1: è™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹çš„åŒºåˆ«ï¼Ÿ**

ç­”ï¼š
- è™šæ‹Ÿçº¿ç¨‹ç”± JVM è°ƒåº¦ï¼Œå¹³å°çº¿ç¨‹ç”± OS è°ƒåº¦
- è™šæ‹Ÿçº¿ç¨‹æ ˆå†…å­˜å°ï¼ˆKBçº§ï¼‰ï¼Œå¹³å°çº¿ç¨‹å¤§ï¼ˆMBçº§ï¼‰
- è™šæ‹Ÿçº¿ç¨‹å¯ä»¥åˆ›å»ºæ•°ç™¾ä¸‡ä¸ªï¼Œå¹³å°çº¿ç¨‹å— OS é™åˆ¶

**Q2: è™šæ‹Ÿçº¿ç¨‹ä¼šå–ä»£å“åº”å¼ç¼–ç¨‹å—ï¼Ÿ**

ç­”ï¼šä¸å®Œå…¨å–ä»£ã€‚è™šæ‹Ÿçº¿ç¨‹ç®€åŒ–äº† I/O å¯†é›†å‹åœºæ™¯ï¼Œä½†å“åº”å¼ä»æœ‰ä¼˜åŠ¿ï¼š
- èƒŒå‹æœºåˆ¶
- æµå¼æ•°æ®å¤„ç†
- æˆç†Ÿçš„æ“ä½œç¬¦ç”Ÿæ€

**Q3: ä»€ä¹ˆæ˜¯ Pinningï¼Ÿ**

ç­”ï¼šè™šæ‹Ÿçº¿ç¨‹åœ¨æ‰§è¡Œ synchronized å—æˆ– native æ–¹æ³•æ—¶æ— æ³•ä»è½½ä½“çº¿ç¨‹å¸è½½ï¼Œç§°ä¸º Pinningã€‚åº”è¯¥ä½¿ç”¨ `ReentrantLock` æ›¿ä»£ `synchronized`ã€‚

### ğŸ¤” äº‰è®®ä¸åæ€

è™šæ‹Ÿçº¿ç¨‹æ˜¯å¦ä¼šå–ä»£å“åº”å¼ï¼Ÿ

> ğŸ’¡ **è§‚ç‚¹**ï¼šè™šæ‹Ÿçº¿ç¨‹ç®€åŒ–äº†å¤§å¤šæ•°åœºæ™¯ï¼Œä½†å“åº”å¼åœ¨æµå¤„ç†ã€èƒŒå‹ç­‰åœºæ™¯ä»æœ‰ç‹¬ç‰¹ä»·å€¼ã€‚æœªæ¥å¯èƒ½æ˜¯ä¸¤è€…å…±å­˜ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [JEP 444: Virtual Threads](https://openjdk.org/jeps/444)
- [Project Loom](https://openjdk.org/projects/loom/)
- [Virtual Threads - Spring Blog](https://spring.io/blog/2022/10/11/embracing-virtual-threads)

---

<p align="center">
  â¬…ï¸ <a href="./01-ç°ä»£è¯­è¨€ç‰¹æ€§.md">ä¸Šä¸€ç¯‡ï¼šç°ä»£è¯­è¨€ç‰¹æ€§</a> |
  ğŸ  <a href="../../README.md">è¿”å›ç›®å½•</a> |
  <a href="./03-GraalVMä¸Native.md">ä¸‹ä¸€ç¯‡ï¼šGraalVMä¸Native</a> â¡ï¸
</p>

