# é…ç½®è§£æä¸å¯åŠ¨æµç¨‹

> ğŸ“Š **éš¾åº¦**ï¼šğŸ”´ é«˜çº§ | â±ï¸ **é˜…è¯»æ—¶é—´**ï¼š40 åˆ†é’Ÿ
>
> ğŸ“ **æœ¬ç« æ‘˜è¦**ï¼šæ·±å…¥åˆ†æ MyBatis çš„å¯åŠ¨æµç¨‹ï¼Œä» XML é…ç½®æ–‡ä»¶è§£æåˆ° Configuration å¯¹è±¡æ„å»ºï¼Œå†åˆ° SqlSessionFactory çš„åˆ›å»ºã€‚

## ğŸ¯ å­¦ä¹ ç›®æ ‡

å­¦å®Œæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š

- ç†è§£ MyBatis å¯åŠ¨æ—¶é…ç½®æ–‡ä»¶çš„è§£æé¡ºåº
- æŒæ¡ XMLConfigBuilder çš„æ ¸å¿ƒè§£æé€»è¾‘
- ç†è§£ Configuration å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹
- äº†è§£ Environmentã€TypeHandler ç­‰ç»„ä»¶çš„æ³¨å†Œæœºåˆ¶

---

## ç¬¬ä¸€å±‚ï¼šå®è§‚æ¶æ„

### 1.1 å¯åŠ¨æµç¨‹å…¨æ™¯å›¾

```mermaid
flowchart TB
    subgraph è¾“å…¥
        XML1[mybatis-config.xml]
        XML2[Mapper.xml]
    end
    
    XML1 --> SSFB[SqlSessionFactoryBuilder]
    SSFB --> |new| XCB[XMLConfigBuilder]
    XCB --> |parse| CONFIG[Configuration]
    
    CONFIG --> |åŒ…å«| P1[properties]
    CONFIG --> |åŒ…å«| P2[settings]
    CONFIG --> |åŒ…å«| P3[typeAliases]
    CONFIG --> |åŒ…å«| P4[typeHandlers]
    CONFIG --> |åŒ…å«| P5[plugins]
    CONFIG --> |åŒ…å«| P6[environments]
    CONFIG --> |åŒ…å«| P7[mappers]
    
    XML2 --> |mappersElement| XMB[XMLMapperBuilder]
    XMB --> |parse| CONFIG
    
    CONFIG --> DSSF[DefaultSqlSessionFactory]
```

**æµç¨‹è¯´æ˜ï¼š**

| æ­¥éª¤ | ç»„ä»¶ | ä½œç”¨ |
|:----:|------|------|
| 1 | SqlSessionFactoryBuilder | å¯åŠ¨å…¥å£ |
| 2 | XMLConfigBuilder | è§£æä¸»é…ç½®æ–‡ä»¶ |
| 3 | XMLMapperBuilder | è§£æ Mapper æ–‡ä»¶ |
| 4 | Configuration | æ±‡æ€»æ‰€æœ‰é…ç½® |
| 5 | DefaultSqlSessionFactory | æœ€ç»ˆäº§ç‰© |

### 1.2 é…ç½®è§£æé¡ºåº

XMLConfigBuilder æŒ‰ç…§ç‰¹å®šé¡ºåºè§£æé…ç½®å…ƒç´ ï¼š

| é¡ºåº | æ–¹æ³• | è§£æå†…å®¹ | è¯´æ˜ |
|:----:|------|---------|------|
| 1 | `propertiesElement()` | properties | å±æ€§é…ç½®ï¼ˆæœ€å…ˆè§£æï¼Œä¾›åç»­ä½¿ç”¨ï¼‰ |
| 2 | `settingsAsProperties()` | settings | è®¾ç½®é¡¹ |
| 3 | `typeAliasesElement()` | typeAliases | ç±»å‹åˆ«å |
| 4 | `pluginsElement()` | plugins | æ’ä»¶ |
| 5 | `objectFactoryElement()` | objectFactory | å¯¹è±¡å·¥å‚ |
| 6 | `reflectorFactoryElement()` | reflectorFactory | åå°„å·¥å‚ |
| 7 | `settingsElement()` | - | åº”ç”¨è®¾ç½®åˆ° Configuration |
| 8 | `environmentsElement()` | environments | ç¯å¢ƒé…ç½® |
| 9 | `databaseIdProviderElement()` | databaseIdProvider | æ•°æ®åº“å‚å•†æ ‡è¯† |
| 10 | `typeHandlersElement()` | typeHandlers | ç±»å‹å¤„ç†å™¨ |
| 11 | `mappersElement()` | mappers | Mapper æ˜ å°„ï¼ˆæœ€åè§£æï¼‰ |

---

## ç¬¬äºŒå±‚ï¼šæ¨¡å—èŒè´£

### 2.1 æ ¸å¿ƒç±»èŒè´£

| ç±»å | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| `SqlSessionFactoryBuilder` | å¯åŠ¨å…¥å£ï¼Œæ„å»ºå·¥å‚ | InputStream/Reader | SqlSessionFactory |
| `XMLConfigBuilder` | è§£æä¸»é…ç½®æ–‡ä»¶ | XML é…ç½®æµ | Configuration |
| `XMLMapperBuilder` | è§£æ Mapper æ–‡ä»¶ | Mapper XML | MappedStatement |
| `Configuration` | å­˜å‚¨æ‰€æœ‰é…ç½® | - | - |

### 2.2 æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant App as Application
    participant SSFB as SqlSessionFactoryBuilder
    participant XCB as XMLConfigBuilder
    participant Config as Configuration

    App->>SSFB: build(inputStream)
    SSFB->>XCB: new XMLConfigBuilder()
    XCB->>Config: new Configuration()
    SSFB->>XCB: parse()
    XCB->>Config: parseConfiguration()
    Config-->>XCB: é…ç½®å®Œæˆ
    XCB-->>SSFB: configuration
    SSFB->>SSFB: new DefaultSqlSessionFactory(config)
    SSFB-->>App: SqlSessionFactory
```

### 2.3 å…³é”®é…ç½®é¡¹

#### mybatis-config.xml ç¤ºä¾‹

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <!-- 1. å±æ€§é…ç½® -->
    <properties resource="db.properties"/>
    
    <!-- 2. è®¾ç½®é¡¹ -->
    <settings>
        <setting name="cacheEnabled" value="true"/>
        <setting name="lazyLoadingEnabled" value="false"/>
        <setting name="mapUnderscoreToCamelCase" value="true"/>
    </settings>
    
    <!-- 3. ç±»å‹åˆ«å -->
    <typeAliases>
        <package name="com.example.domain"/>
    </typeAliases>
    
    <!-- 4. æ’ä»¶ -->
    <plugins>
        <plugin interceptor="com.example.plugin.MyPlugin"/>
    </plugins>
    
    <!-- 5. ç¯å¢ƒé…ç½® -->
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="${db.driver}"/>
                <property name="url" value="${db.url}"/>
                <property name="username" value="${db.username}"/>
                <property name="password" value="${db.password}"/>
            </dataSource>
        </environment>
    </environments>
    
    <!-- 6. Mapper æ˜ å°„ -->
    <mappers>
        <mapper resource="mapper/UserMapper.xml"/>
        <package name="com.example.mapper"/>
    </mappers>
</configuration>
```

---

## ç¬¬ä¸‰å±‚ï¼šæºç æ·±å…¥

### 3.1 SqlSessionFactoryBuilder

å…¥å£ç±»ï¼Œæä¾›å¤šç§æ„å»ºæ–¹å¼ï¼š

```java
public class SqlSessionFactoryBuilder {

    // æ ¸å¿ƒæ„å»ºæ–¹æ³•
    public SqlSessionFactory build(InputStream inputStream, 
                                   String environment, 
                                   Properties properties) {
        try {
            // 1. åˆ›å»º XMLConfigBuilder
            XMLConfigBuilder parser = new XMLConfigBuilder(
                inputStream, environment, properties);
            
            // 2. è§£æé…ç½®ï¼Œæ„å»º SqlSessionFactory
            return build(parser.parse());
        } catch (Exception e) {
            throw ExceptionFactory.wrapException("Error building SqlSession.", e);
        } finally {
            // 3. å…³é—­è¾“å…¥æµ
            try { if (inputStream != null) inputStream.close(); } 
            catch (IOException e) { /* ignore */ }
        }
    }

    // ç”¨ Configuration æ„å»º SqlSessionFactory
    public SqlSessionFactory build(Configuration config) {
        return new DefaultSqlSessionFactory(config);
    }
}
```

### 3.2 XMLConfigBuilder.parse()

è§£æå…¥å£ï¼Œåªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼š

```java
public class XMLConfigBuilder extends BaseBuilder {

    private boolean parsed;
    private final XPathParser parser;
    private String environment;

    public Configuration parse() {
        // é˜²æ­¢é‡å¤è§£æ
        if (parsed) {
            throw new BuilderException(
                "Each XMLConfigBuilder can only be used once.");
        }
        parsed = true;
        
        // è§£æ <configuration> æ ¹èŠ‚ç‚¹
        parseConfiguration(parser.evalNode("/configuration"));
        return configuration;
    }
}
```

### 3.3 parseConfiguration() æ ¸å¿ƒæ–¹æ³•

```java
private void parseConfiguration(XNode root) {
    try {
        // 1. è§£æ <properties>ï¼Œä¾›åç»­å˜é‡æ›¿æ¢ä½¿ç”¨
        propertiesElement(root.evalNode("properties"));
        
        // 2. è§£æ <settings>ï¼Œè·å–è®¾ç½®å±æ€§
        Properties settings = settingsAsProperties(root.evalNode("settings"));
        loadCustomVfsImpl(settings);
        loadCustomLogImpl(settings);
        
        // 3. è§£æ <typeAliases>
        typeAliasesElement(root.evalNode("typeAliases"));
        
        // 4. è§£æ <plugins>
        pluginsElement(root.evalNode("plugins"));
        
        // 5. è§£æ <objectFactory>
        objectFactoryElement(root.evalNode("objectFactory"));
        
        // 6. è§£æ <objectWrapperFactory>
        objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));
        
        // 7. è§£æ <reflectorFactory>
        reflectorFactoryElement(root.evalNode("reflectorFactory"));
        
        // 8. åº”ç”¨ settings åˆ° configuration
        settingsElement(settings);
        
        // 9. è§£æ <environments>ï¼ˆåœ¨ objectFactory ä¹‹åï¼‰
        environmentsElement(root.evalNode("environments"));
        
        // 10. è§£æ <databaseIdProvider>
        databaseIdProviderElement(root.evalNode("databaseIdProvider"));
        
        // 11. è§£æ <typeHandlers>
        typeHandlersElement(root.evalNode("typeHandlers"));
        
        // 12. è§£æ <mappers>ï¼ˆæœ€åè§£æï¼‰
        mappersElement(root.evalNode("mappers"));
        
    } catch (Exception e) {
        throw new BuilderException(
            "Error parsing SQL Mapper Configuration. Cause: " + e, e);
    }
}
```

### 3.4 environmentsElement() ç¯å¢ƒè§£æ

```java
private void environmentsElement(XNode context) throws Exception {
    if (context == null) return;
    
    // è·å–é»˜è®¤ç¯å¢ƒ ID
    if (environment == null) {
        environment = context.getStringAttribute("default");
    }
    
    // éå†æ‰€æœ‰ <environment>
    for (XNode child : context.getChildren()) {
        String id = child.getStringAttribute("id");
        
        // åªè§£ææŒ‡å®šçš„ç¯å¢ƒ
        if (isSpecifiedEnvironment(id)) {
            // è§£æäº‹åŠ¡ç®¡ç†å™¨
            TransactionFactory txFactory = 
                transactionManagerElement(child.evalNode("transactionManager"));
            
            // è§£ææ•°æ®æº
            DataSourceFactory dsFactory = 
                dataSourceElement(child.evalNode("dataSource"));
            DataSource dataSource = dsFactory.getDataSource();
            
            // æ„å»º Environment å¯¹è±¡
            Environment.Builder environmentBuilder = 
                new Environment.Builder(id)
                    .transactionFactory(txFactory)
                    .dataSource(dataSource);
            
            configuration.setEnvironment(environmentBuilder.build());
            break; // åªå¤„ç†ä¸€ä¸ªç¯å¢ƒ
        }
    }
}
```

### 3.5 mappersElement() Mapper è§£æ

```java
private void mappersElement(XNode context) throws Exception {
    if (context == null) return;
    
    for (XNode child : context.getChildren()) {
        if ("package".equals(child.getName())) {
            // æ–¹å¼1ï¼šåŒ…æ‰«æ
            String mapperPackage = child.getStringAttribute("name");
            configuration.addMappers(mapperPackage);
            
        } else {
            String resource = child.getStringAttribute("resource");
            String url = child.getStringAttribute("url");
            String mapperClass = child.getStringAttribute("class");
            
            if (resource != null && url == null && mapperClass == null) {
                // æ–¹å¼2ï¼šé€šè¿‡ resource åŠ è½½
                ErrorContext.instance().resource(resource);
                try (InputStream inputStream = 
                         Resources.getResourceAsStream(resource)) {
                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(
                        inputStream, configuration, resource, 
                        configuration.getSqlFragments());
                    mapperParser.parse();
                }
                
            } else if (resource == null && url != null && mapperClass == null) {
                // æ–¹å¼3ï¼šé€šè¿‡ URL åŠ è½½
                ErrorContext.instance().resource(url);
                try (InputStream inputStream = 
                         Resources.getUrlAsStream(url)) {
                    XMLMapperBuilder mapperParser = new XMLMapperBuilder(
                        inputStream, configuration, url, 
                        configuration.getSqlFragments());
                    mapperParser.parse();
                }
                
            } else if (resource == null && url == null && mapperClass != null) {
                // æ–¹å¼4ï¼šé€šè¿‡ class æ³¨å†Œ
                Class<?> mapperInterface = Resources.classForName(mapperClass);
                configuration.addMapper(mapperInterface);
                
            } else {
                throw new BuilderException(
                    "A mapper element may only specify a url, resource or class, " +
                    "but not more than one.");
            }
        }
    }
}
```

### 3.6 Configuration æ ¸å¿ƒç»“æ„

```java
public class Configuration {
    
    // ============ ç¯å¢ƒç›¸å…³ ============
    protected Environment environment;
    
    // ============ æ³¨å†Œè¡¨ ============
    protected final MapperRegistry mapperRegistry = new MapperRegistry(this);
    protected final TypeAliasRegistry typeAliasRegistry = new TypeAliasRegistry();
    protected final TypeHandlerRegistry typeHandlerRegistry = new TypeHandlerRegistry(this);
    protected final LanguageDriverRegistry languageRegistry = new LanguageDriverRegistry();
    
    // ============ SQL æ˜ å°„ ============
    protected final Map<String, MappedStatement> mappedStatements = 
        new StrictMap<>("Mapped Statements");
    protected final Map<String, Cache> caches = 
        new StrictMap<>("Caches");
    protected final Map<String, ResultMap> resultMaps = 
        new StrictMap<>("Result Maps");
    protected final Map<String, ParameterMap> parameterMaps = 
        new StrictMap<>("Parameter Maps");
    protected final Map<String, KeyGenerator> keyGenerators = 
        new StrictMap<>("Key Generators");
    protected final Map<String, XNode> sqlFragments = 
        new StrictMap<>("XML fragments");
    
    // ============ æ’ä»¶ ============
    protected final InterceptorChain interceptorChain = new InterceptorChain();
    
    // ============ å·¥å‚ ============
    protected ObjectFactory objectFactory = new DefaultObjectFactory();
    protected ObjectWrapperFactory objectWrapperFactory = 
        new DefaultObjectWrapperFactory();
    protected ReflectorFactory reflectorFactory = new DefaultReflectorFactory();
    
    // ============ è®¾ç½®é¡¹ ============
    protected boolean cacheEnabled = true;
    protected boolean lazyLoadingEnabled = false;
    protected boolean useGeneratedKeys = false;
    protected boolean mapUnderscoreToCamelCase = false;
    protected ExecutorType defaultExecutorType = ExecutorType.SIMPLE;
    protected Integer defaultStatementTimeout;
    // ... æ›´å¤šè®¾ç½®é¡¹
}
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **è§£æé¡ºåº**ï¼šproperties æœ€å…ˆè§£æï¼Œmappers æœ€åè§£æï¼Œä¿è¯ä¾èµ–å…³ç³»
2. **å•æ¬¡è§£æ**ï¼šXMLConfigBuilder åªèƒ½è°ƒç”¨ä¸€æ¬¡ `parse()`
3. **Configuration ä¸­å¿ƒåŒ–**ï¼šæ‰€æœ‰é…ç½®æœ€ç»ˆæ±‡èšåˆ° Configuration å¯¹è±¡
4. **å¤šç§ Mapper åŠ è½½æ–¹å¼**ï¼šæ”¯æŒ packageã€resourceã€urlã€class å››ç§æ–¹å¼

### å¯åŠ¨æµç¨‹ç²¾ç®€ç‰ˆ

```
SqlSessionFactoryBuilder.build()
    â””â”€â”€ new XMLConfigBuilder().parse()
            â””â”€â”€ parseConfiguration()
                    â”œâ”€â”€ properties
                    â”œâ”€â”€ settings
                    â”œâ”€â”€ typeAliases
                    â”œâ”€â”€ plugins
                    â”œâ”€â”€ environments
                    â”œâ”€â”€ typeHandlers
                    â””â”€â”€ mappers
    â””â”€â”€ new DefaultSqlSessionFactory(configuration)
```

### ä¸‹ä¸€æ­¥

æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ·±å…¥ **Mapper ä»£ç†æœºåˆ¶**ï¼Œäº†è§£ MyBatis æ˜¯å¦‚ä½•é€šè¿‡åŠ¨æ€ä»£ç†å®ç°æ¥å£ä¸ SQL æ˜ å°„çš„ç»‘å®šçš„ã€‚

---

| â¬…ï¸ ä¸Šä¸€ç«  | ğŸ  ç›®å½• | ä¸‹ä¸€ç«  â¡ï¸ |
|:----------|:------:|----------:|
| [å…¨å±€æ¶æ„æ¦‚è§ˆ](../01-å…¨å±€æ¶æ„æ¦‚è§ˆ/01-MyBatiså…¨å±€æ¶æ„.md) | [è¿”å›ç›®å½•](../../) | [Mapper ä»£ç†æœºåˆ¶](../03-Mapperä»£ç†æœºåˆ¶/01-Mapperä»£ç†æœºåˆ¶.md) |

